<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>HerbTrace â€¢ Verified Herbal Community</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #1b5e2a;
            --primary-light: #4c8b5a;
            --primary-dark: #0e3b1a;
            --surface: #ffffff;
            --background: #f5f9f3;
            --text: #1a2e18;
            --text-light: #4a5f47;
            --border: #d4e8d1;
            --success: #2e7d5e;
            --danger: #b84a4a;
            --warning: #cc7b2b;
            --verified: #2a7faa;
            --gold: #fbbf24;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--background);
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 70px;
        }
        .app-container {
            max-width: 480px;
            margin: 0 auto;
            background: var(--background);
            position: relative;
        }
        .header {
            background: var(--surface);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
            cursor: pointer;
        }
        .auth-buttons {
            display: flex;
            gap: 10px;
        }
        .btn {
            padding: 8px 16px;
            border-radius: 30px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        .btn-success {
            background: var(--success);
            color: white;
        }
        .btn-sm {
            padding: 4px 12px;
            font-size: 0.8rem;
        }
        .search-section {
            padding: 15px 20px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
        }
        .search-bar {
            background: var(--background);
            border-radius: 30px;
            padding: 12px 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid var(--border);
        }
        .search-bar input {
            border: none;
            background: transparent;
            width: 100%;
            font-size: 0.95rem;
            outline: none;
        }
        .feed {
            padding: 15px;
        }
        .post-card {
            background: var(--surface);
            border-radius: 24px;
            padding: 18px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,30,0,0.05);
            border: 1px solid var(--border);
        }
        .post-header {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            align-items: center;
        }
        .avatar {
            width: 48px;
            height: 48px;
            background: var(--primary-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.2rem;
        }
        .verified-badge {
            background: var(--verified);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 30px;
            margin-left: 5px;
            display: inline-block;
        }
        .herb-tag {
            display: inline-block;
            background: var(--background);
            padding: 6px 12px;
            border-radius: 30px;
            font-size: 0.85rem;
            margin: 5px 0;
            border: 1px solid var(--border);
        }
        .rating-section {
            background: var(--background);
            border-radius: 20px;
            padding: 15px;
            margin: 15px 0;
        }
        .rating-question {
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--primary-dark);
        }
        .rating-buttons {
            display: flex;
            gap: 8px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        .rating-btn {
            flex: 1;
            min-width: 100px;
            padding: 12px;
            border: 2px solid transparent;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
            background: white;
            transition: all 0.2s;
        }
        .rating-btn.working { 
            color: var(--success); 
            border-color: var(--success); 
        }
        .rating-btn.working:hover,
        .rating-btn.working.selected { 
            background: var(--success); 
            color: white; 
        }
        .rating-btn.not-working { 
            color: var(--danger); 
            border-color: var(--danger); 
        }
        .rating-btn.not-working:hover,
        .rating-btn.not-working.selected { 
            background: var(--danger); 
            color: white; 
        }
        .rating-btn.unsure { 
            color: var(--warning); 
            border-color: var(--warning); 
        }
        .rating-btn.unsure:hover,
        .rating-btn.unsure.selected { 
            background: var(--warning); 
            color: white; 
        }
        .rating-stats {
            display: flex;
            gap: 15px;
            margin-top: 12px;
            font-size: 0.85rem;
            color: var(--text-light);
            flex-wrap: wrap;
        }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 480px;
            margin: 0 auto;
            background: var(--surface);
            display: flex;
            justify-content: space-around;
            padding: 12px 0 8px;
            border-top: 2px solid var(--border);
            z-index: 1000;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            color: var(--text-light);
            font-size: 0.8rem;
            gap: 4px;
        }
        .nav-item i {
            font-size: 1.3rem;
        }
        .nav-item.active { 
            color: var(--primary); 
        }
        .modal {
            display: none;
            position: fixed;
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal.active { 
            display: flex; 
        }
        .modal-content {
            background: white;
            border-radius: 32px;
            padding: 25px;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .form-group input, 
        .form-group select, 
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 16px;
            font-size: 1rem;
            font-family: inherit;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }
        .error-message {
            color: var(--danger);
            font-size: 0.9rem;
            margin-top: 5px;
            padding: 10px;
            background: #fee;
            border-radius: 8px;
        }
        .success-message {
            color: var(--success);
            padding: 10px;
            background: #e8f5e9;
            border-radius: 8px;
        }
        .user-menu {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .welcome-card {
            text-align: center;
            padding: 40px 20px;
            background: var(--surface);
            border-radius: 24px;
            margin: 20px;
        }
        .admin-badge {
            background: var(--gold);
            color: var(--primary-dark);
            padding: 4px 8px;
            border-radius: 30px;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
        }
        .spinner {
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-dark);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 500;
            z-index: 3000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .toast.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <div class="logo" onclick="location.reload()">
                <i class="fas fa-leaf"></i>
                <span>HerbTrace</span>
            </div>
            <div class="auth-buttons" id="authButtons">
                <button class="btn btn-outline" onclick="showModal('loginModal')">Login</button>
                <button class="btn btn-primary" onclick="showModal('signupModal')">Sign Up</button>
            </div>
            <div class="user-menu" id="userMenu" style="display: none;">
                <i class="fas fa-plus-circle" style="font-size: 1.5rem; cursor: pointer;" onclick="showModal('createPostModal')"></i>
                <i class="fas fa-bell" style="cursor: pointer;"></i>
                <i class="fas fa-user-circle" style="font-size: 2rem; cursor: pointer;" onclick="showProfile()"></i>
            </div>
        </div>

        <div id="toast" class="toast"></div>

        <div class="search-section">
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Search herbs..." onkeyup="handleSearchInput()">
            </div>
        </div>

        <div id="contentArea">
            <div class="feed" id="feed">
                <div class="loading">
                    <i class="fas fa-leaf fa-spin" style="font-size: 3rem; color: var(--primary-light); margin-bottom: 15px;"></i>
                    <h3>Loading HerbTrace...</h3>
                    <p style="margin-top: 10px; color: var(--text-light);">Connecting to the herbal community</p>
                </div>
            </div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" data-tab="home" onclick="switchTab(this)">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </div>
            <div class="nav-item" data-tab="explore" onclick="switchTab(this)">
                <i class="fas fa-search"></i>
                <span>Explore</span>
            </div>
            <div class="nav-item" data-tab="scan" onclick="switchTab(this)">
                <i class="fas fa-qrcode"></i>
                <span>Scan</span>
            </div>
            <div class="nav-item" data-tab="profile" onclick="switchTab(this)">
                <i class="fas fa-user"></i>
                <span>Profile</span>
            </div>
        </div>
    </div>

    <div class="modal" id="loginModal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">Login to HerbTrace</h2>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="loginEmail" placeholder="your@email.com">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
            <div id="loginError" class="error-message" style="display: none;"></div>
            <button class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="handleLogin()">Login</button>
            <button class="btn btn-outline" style="width: 100%;" onclick="closeModal('loginModal')">Cancel</button>
        </div>
    </div>

    <div class="modal" id="signupModal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">Create Account</h2>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="signupEmail" placeholder="your@email.com">
            </div>
            <div class="form-group">
                <label>Password (min 6 chars)</label>
                <input type="password" id="signupPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="signupUsername" placeholder="herbalist123">
            </div>
            <div class="form-group">
                <label>I am a...</label>
                <select id="signupUserType">
                    <option value="consumer">Consumer / Enthusiast</option>
                    <option value="herbalist">Herbalist / Practitioner</option>
                    <option value="brand">Brand / Manufacturer</option>
                </select>
            </div>
            <div id="signupError" class="error-message" style="display: none;"></div>
            <button class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="handleSignup()">Sign Up</button>
            <button class="btn btn-outline" style="width: 100%;" onclick="closeModal('signupModal')">Cancel</button>
        </div>
    </div>

    <div class="modal" id="createPostModal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">Share Experience</h2>
            <div class="form-group">
                <label>Select Herb</label>
                <select id="postHerbId">
                    <option value="">Loading herbs...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Your Experience</label>
                <textarea id="postContent" placeholder="Share your experience with this herb..." rows="4"></textarea>
            </div>
            <div class="form-group">
                <label>Post Type</label>
                <select id="postType">
                    <option value="experience">Personal Experience</option>
                    <option value="traditional">Traditional Knowledge</option>
                    <option value="question">Question</option>
                </select>
            </div>
            <div id="postError" class="error-message" style="display: none;"></div>
            <button class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="createPost()">Share Post</button>
            <button class="btn btn-outline" style="width: 100%;" onclick="closeModal('createPostModal')">Cancel</button>
        </div>
    </div>

    <div class="modal" id="qrModal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">Scan Product QR</h2>
            <div style="background: var(--background); height: 200px; border-radius: 20px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; border: 2px dashed var(--border);">
                <i class="fas fa-camera" style="font-size: 3rem; color: var(--text-light);"></i>
            </div>
            <p style="margin-bottom: 20px;">Scan a product QR code to verify batch authenticity.</p>
            <div id="qrResult" style="margin-bottom: 15px;"></div>
            <button class="btn btn-primary" style="width: 100%;" onclick="simulateQRScan()">Simulate Scan</button>
            <button class="btn btn-outline" style="width: 100%; margin-top: 10px;" onclick="closeModal('qrModal')">Close</button>
        </div>
    </div>

    <div class="modal" id="ratingModal">
        <div class="modal-content">
            <h3 id="ratingModalTitle">Thanks for voting! ðŸŒ¿</h3>
            <p id="ratingModalMessage">Your experience helps the community.</p>
            <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="closeModal('ratingModal')">Close</button>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const SUPABASE_URL = 'https://kfkjystvuumfbocqyvwl.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_MJi-Z9uOMPZtPn2hxUtWww_P9E_b9Zq';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ==================== GLOBAL STATE ====================
        let currentUser = null;
        let currentSession = null;
        let isAdmin = false;
        let searchTimeout = null;

        const DEMO_HERBS = [
            { id: '1', name: 'Ashwagandha', scientific_name: 'Withania somnifera', description: 'Adaptogenic herb used for stress and anxiety.' },
            { id: '2', name: 'Echinacea', scientific_name: 'Echinacea purpurea', description: 'Immune support and cold prevention.' },
            { id: '3', name: 'Milk Thistle', scientific_name: 'Silybum marianum', description: 'Liver health and detoxification.' },
            { id: '4', name: 'Turmeric', scientific_name: 'Curcuma longa', description: 'Anti-inflammatory and antioxidant.' },
            { id: '5', name: 'Ginger', scientific_name: 'Zingiber officinale', description: 'Digestive health and nausea relief.' }
        ];

        const DEMO_POSTS = [
            {
                id: '1',
                profiles: { username: 'Dr. Sarah', verified: true, user_type: 'herbalist' },
                herbs: { name: 'Ashwagandha' },
                content: "I've been prescribing Ashwagandha for stress for 10 years. Best results with consistent daily use for at least 4 weeks.",
                created_at: new Date(Date.now() - 7200000).toISOString()
            },
            {
                id: '2',
                profiles: { username: 'Mike R.', verified: false, user_type: 'consumer' },
                herbs: { name: 'Echinacea' },
                content: 'Took Echinacea at first sign of cold symptoms. Felt better within 48 hours!',
                created_at: new Date(Date.now() - 86400000).toISOString()
            }
        ];

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('HerbTrace initializing...');
            
            setTimeout(() => {
                if (document.querySelector('.loading')) {
                    console.log('Loading timeout - showing demo feed');
                    showDemoFeed();
                }
            }, 3000);
            
            try {
                await checkUser();
                await loadHerbsForSelect();
                showDemoFeed();
                
                setTimeout(() => {
                    loadFeed();
                }, 100);
            } catch (error) {
                console.error('Initialization error:', error);
                showDemoFeed();
            }
        });

        // ==================== AUTH FUNCTIONS ====================
        async function checkUser() {
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) throw error;
                
                if (session) {
                    currentSession = session;
                    currentUser = session.user;
                    
                    document.getElementById('authButtons').style.display = 'none';
                    document.getElementById('userMenu').style.display = 'flex';
                    
                    checkAdminStatus().catch(console.log);
                }
            } catch (error) {
                console.error('Auth check error:', error);
            }
        }

        async function checkAdminStatus() {
            if (!currentUser) return;
            
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('is_admin')
                    .eq('id', currentUser.id)
                    .single();

                if (!error && data?.is_admin) {
                    isAdmin = true;
                    addAdminBadge();
                }
            } catch (error) {
                console.log('Admin check failed:', error.message);
            }
        }

        function addAdminBadge() {
            const userMenu = document.getElementById('userMenu');
            if (document.querySelector('.admin-badge')) return;
            
            const adminBadge = document.createElement('span');
            adminBadge.className = 'admin-badge';
            adminBadge.innerHTML = '<i class="fas fa-crown"></i> Admin';
            adminBadge.onclick = showAdminInfo;
            userMenu.prepend(adminBadge);
        }

        // ==================== MODAL FUNCTIONS ====================
        function showModal(modalId) {
            document.querySelectorAll('.modal.active').forEach(modal => {
                modal.classList.remove('active');
            });
            
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
                
                const errorDiv = modal.querySelector('.error-message');
                if (errorDiv) {
                    errorDiv.style.display = 'none';
                    errorDiv.textContent = '';
                }
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            if (!toast) return;
            
            toast.textContent = message;
            toast.style.background = type === 'success' ? 'var(--primary-dark)' : 'var(--danger)';
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ==================== LOGIN ====================
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            if (!email || !password) {
                errorDiv.textContent = 'Please enter both email and password';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;

                closeModal('loginModal');
                await checkUser();
                showToast('Login successful!');
                showDemoFeed();
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            }
        }

        // ==================== SIGNUP ====================
        async function handleSignup() {
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const username = document.getElementById('signupUsername').value.trim();
            const userType = document.getElementById('signupUserType').value;
            const errorDiv = document.getElementById('signupError');

            if (!email || !password || !username) {
                errorDiv.textContent = 'Please fill in all fields';
                errorDiv.style.display = 'block';
                return;
            }

            if (password.length < 6) {
                errorDiv.textContent = 'Password must be at least 6 characters';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            username: username,
                            user_type: userType
                        }
                    }
                });

                if (error) throw error;

                closeModal('signupModal');
                showToast('Account created! Please check your email for confirmation.');
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            }
        }

        // ==================== LOGOUT ====================
        async function logout() {
            await supabase.auth.signOut();
            currentUser = null;
            currentSession = null;
            isAdmin = false;
            
            document.getElementById('authButtons').style.display = 'flex';
            document.getElementById('userMenu').style.display = 'none';
            
            const adminBadge = document.querySelector('.admin-badge');
            if (adminBadge) adminBadge.remove();
            
            showToast('Logged out successfully');
            showDemoFeed();
        }

        // ==================== UTILITY FUNCTIONS ====================
        function sanitizeInput(input) {
            if (!input) return '';
            return String(input).replace(/[<>]/g, '');
        }

        // ==================== TAB SWITCHING ====================
        function switchTab(tabElement) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            tabElement.classList.add('active');
            
            const tab = tabElement.getAttribute('data-tab');
            
            if (tab === 'scan') {
                showModal('qrModal');
            } else if (tab === 'profile') {
                handleProfileTab();
            } else if (tab === 'explore') {
                loadExplore();
            } else if (tab === 'home') {
                showDemoFeed();
            }
        }

        function handleProfileTab() {
            if (!currentUser) {
                showModal('loginModal');
            } else {
                showProfile();
            }
        }

        function showProfile() {
            if (!currentUser) {
                showModal('loginModal');
                return;
            }
            
            const feed = document.getElementById('feed');
            feed.innerHTML = `
                <div class="post-card">
                    <h3><i class="fas fa-user-circle"></i> User Profile</h3>
                    <p><strong>Email:</strong> ${currentUser.email}</p>
                    <p><strong>User ID:</strong> ${currentUser.id.substring(0, 8)}...</p>
                    <p><strong>Admin:</strong> ${isAdmin ? 'Yes' : 'No'}</p>
                    <button class="btn btn-danger" style="width: 100%; margin-top: 15px;" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            `;
        }

        function showAdminInfo() {
            showToast('Admin Dashboard - Feature coming soon!', 'success');
        }

        // ==================== LOAD FEED ====================
        async function loadFeed() {
            if (!currentUser) return;
            
            try {
                const { data: posts, error } = await supabase
                    .from('posts')
                    .select(`
                        *,
                        profiles:user_id (username, user_type, verified),
                        herbs:herb_id (name)
                    `)
                    .order('created_at', { ascending: false })
                    .limit(20);

                if (error) throw error;

                if (posts && posts.length > 0) {
                    renderFeed(posts);
                }
            } catch (error) {
                console.log('Could not load real posts:', error.message);
            }
        }

        function showDemoFeed() {
            const feed = document.getElementById('feed');
            
            let html = '';
            
            if (!currentUser) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <button class="btn btn-primary" style="width: 100%;" onclick="showModal('signupModal')">
                            <i class="fas fa-leaf"></i> Join HerbTrace
                        </button>
                    </div>
                `;
            } else {
                html += `
                    <div style="margin-bottom: 15px;">
                        <button class="btn btn-primary" style="width: 100%;" onclick="showModal('createPostModal')">
                            <i class="fas fa-plus"></i> Share Your Experience
                        </button>
                    </div>
                `;
            }
            
            DEMO_POSTS.forEach(post => {
                html += renderPostCard(post);
            });
            
            feed.innerHTML = html;
        }

        function renderPostCard(post) {
            const username = post.profiles?.username || 'Anonymous';
            const verified = post.profiles?.verified ? '<span class="verified-badge"><i class="fas fa-check"></i> Verified</span>' : '';
            const herbName = post.herbs?.name || 'Herbal remedy';
            const date = new Date(post.created_at).toLocaleDateString();
            
            return `
                <div class="post-card">
                    <div class="post-header">
                        <div class="avatar">${sanitizeInput(username.charAt(0).toUpperCase())}</div>
                        <div>
                            <h4>${sanitizeInput(username)} ${verified}</h4>
                            <small>${date}</small>
                        </div>
                    </div>
                    <span class="herb-tag"><i class="fas fa-leaf"></i> ${sanitizeInput(herbName)}</span>
                    <p style="margin: 15px 0;">${sanitizeInput(post.content)}</p>
                    
                    <div class="rating-section">
                        <div class="rating-question">Is this herb working for you?</div>
                        <div class="rating-buttons">
                            <button class="rating-btn working" onclick="rateHerb('${sanitizeInput(herbName)}')">
                                <i class="fas fa-check-circle"></i> Working
                            </button>
                            <button class="rating-btn not-working" onclick="rateHerb('${sanitizeInput(herbName)}')">
                                <i class="fas fa-times-circle"></i> Not Working
                            </button>
                            <button class="rating-btn unsure" onclick="rateHerb('${sanitizeInput(herbName)}')">
                                <i class="fas fa-question-circle"></i> Unsure
                            </button>
                        </div>
                        <div class="rating-stats">
                            <span><i class="fas fa-check-circle" style="color: var(--success);"></i> 78% (demo)</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderFeed(posts) {
            const feed = document.getElementById('feed');
            let html = '';
            
            if (currentUser) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <button class="btn btn-primary" style="width: 100%;" onclick="showModal('createPostModal')">
                            <i class="fas fa-plus"></i> Share Your Experience
                        </button>
                    </div>
                `;
            }

            posts.forEach(post => {
                html += renderPostCard(post);
            });

            feed.innerHTML = html;
        }

        // ==================== EXPLORE ====================
        async function loadExplore() {
            showDemoExplore();
            
            try {
                const { data: herbs, error } = await supabase
                    .from('herbs')
                    .select('*')
                    .order('name');

                if (error) throw error;

                if (herbs && herbs.length > 0) {
                    renderExplore(herbs);
                }
            } catch (error) {
                console.log('Could not load real herbs:', error.message);
            }
        }

        function renderExplore(herbs) {
            const feed = document.getElementById('feed');
            let html = '<h3 style="margin-bottom: 15px;">ðŸŒ¿ Herb Library</h3>';
            
            herbs.forEach(herb => {
                html += `
                    <div class="post-card">
                        <h4><i class="fas fa-leaf" style="color: var(--primary);"></i> ${sanitizeInput(herb.name)}</h4>
                        <p><em>${herb.scientific_name ? sanitizeInput(herb.scientific_name) : 'No scientific name'}</em></p>
                        <p>${herb.description ? sanitizeInput(herb.description) : 'No description available.'}</p>
                        ${!currentUser ? '<button class="btn btn-primary btn-sm" style="margin-top: 10px;" onclick="showModal(\'loginModal\')">Login to Rate</button>' : ''}
                    </div>
                `;
            });
            
            feed.innerHTML = html;
        }

        function showDemoExplore() {
            const feed = document.getElementById('feed');
            let html = '<h3 style="margin-bottom: 15px;">ðŸŒ¿ Popular Herbs</h3>';
            
            DEMO_HERBS.forEach(herb => {
                html += `
                    <div class="post-card">
                        <h4><i class="fas fa-leaf" style="color: var(--primary);"></i> ${herb.name}</h4>
                        <p><em>${herb.scientific_name}</em></p>
                        <p>${herb.description}</p>
                        ${!currentUser ? '<button class="btn btn-primary btn-sm" style="margin-top: 10px;" onclick="showModal(\'loginModal\')">Login to Rate</button>' : ''}
                    </div>
                `;
            });
            
            feed.innerHTML = html;
        }

        // ==================== RATING FUNCTION ====================
        function rateHerb(herbName) {
            if (!currentUser) {
                showModal('loginModal');
                return;
            }
            
            document.getElementById('ratingModalTitle').innerHTML = `Thanks for rating ${herbName}! ðŸŒ¿`;
            document.getElementById('ratingModalMessage').innerHTML = 'Your experience helps the community.';
            showModal('ratingModal');
        }

        // ==================== SEARCH ====================
        function handleSearchInput() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                performSearch();
            }, 500);
        }

        function performSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (searchTerm.length < 2) {
                return;
            }

            showDemoSearchResults(searchTerm);
        }

        function showDemoSearchResults(searchTerm) {
            const filteredHerbs = DEMO_HERBS.filter(herb => 
                herb.name.toLowerCase().includes(searchTerm)
            );
            
            const feed = document.getElementById('feed');
            
            if (filteredHerbs.length > 0) {
                let html = `
                    <div class="post-card">
                        <h4>Search Results for "${sanitizeInput(searchTerm)}"</h4>
                        <p>Found ${filteredHerbs.length} matching herb${filteredHerbs.length !== 1 ? 's' : ''}:</p>
                        <ul style="margin-top: 10px; list-style: none;">
                `;
                
                filteredHerbs.forEach(herb => {
                    html += `<li style="margin-bottom: 8px;"><i class="fas fa-leaf" style="color: var(--primary);"></i> ${herb.name}</li>`;
                });
                
                html += `
                        </ul>
                        <button class="btn btn-primary btn-sm" style="margin-top: 15px;" onclick="showDemoFeed()">Back to Feed</button>
                    </div>
                `;
                
                feed.innerHTML = html;
            } else {
                feed.innerHTML = `
                    <div class="post-card">
                        <h4>No results for "${sanitizeInput(searchTerm)}"</h4>
                        <p>Try searching for: Ashwagandha, Echinacea, Turmeric, Ginger, or Milk Thistle</p>
                        <button class="btn btn-primary btn-sm" style="margin-top: 15px;" onclick="showDemoFeed()">Back to Feed</button>
                    </div>
                `;
            }
        }

        // ==================== QR FUNCTIONS ====================
        function simulateQRScan() {
            document.getElementById('qrResult').innerHTML = `
                <div class="success-message">
                    <h4>âœ… Batch Verified!</h4>
                    <p>Batch: ASHW-2025-03</p>
                    <p>Harvested: March 2025</p>
                    <p>Location: India</p>
                    <p>Lab Tested: Eurofins</p>
                </div>
            `;
        }

        // ==================== CREATE POST ====================
        function createPost() {
            const herbId = document.getElementById('postHerbId').value;
            const content = document.getElementById('postContent').value.trim();
            const errorDiv = document.getElementById('postError');

            if (!herbId) {
                errorDiv.textContent = 'Please select an herb';
                errorDiv.style.display = 'block';
                return;
            }

            if (!content) {
                errorDiv.textContent = 'Please enter your experience';
                errorDiv.style.display = 'block';
                return;
            }

            if (content.length < 10) {
                errorDiv.textContent = 'Please write at least 10 characters';
                errorDiv.style.display = 'block';
                return;
            }

            if (!currentUser) {
                closeModal('createPostModal');
                showModal('loginModal');
                return;
            }

            closeModal('createPostModal');
            showToast('Post created! (Demo mode)');
            document.getElementById('postContent').value = '';
        }

        // ==================== LOAD HERBS FOR SELECT ====================
        async function loadHerbsForSelect() {
            const select = document.getElementById('postHerbId');
            if (!select) return;

            select.innerHTML = DEMO_HERBS.map(herb => 
                `<option value="${herb.id}">${herb.name}</option>`
            ).join('');
            
            try {
                const { data: herbs, error } = await supabase
                    .from('herbs')
                    .select('id, name')
                    .order('name');

                if (error) throw error;

                if (herbs && herbs.length > 0) {
                    select.innerHTML = herbs.map(herb => 
                        `<option value="${herb.id}">${sanitizeInput(herb.name)}</option>`
                    ).join('');
                }
            } catch (error) {
                console.log('Could not load real herbs for select:', error.message);
            }
        }
    </script>
</body>
                    </html>
